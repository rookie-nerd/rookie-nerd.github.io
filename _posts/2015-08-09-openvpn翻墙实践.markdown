---
layout: post
title: openvpn翻墙实践
date: 2015-09-08 09:41:14
categories: tools
---

# 原理
vpn的全称叫virtual private network，虚拟专用网络，即利用公网架设专用网络。vpn的作用就是当外地员工想要访问内网资源的时候，外地员工可以通过连接vpn server，然后访问内网资源[vpn原理](http://baike.baidu.com/link?url=1xZna2Iapi4-RWKsx7DhxdVq7wXzZ8TW5_jbxVxZnGhj_P2nR-T6vGzkp94y605_qyfUD5bMvisdSvuT2ASD9seNLDHRS_w9a3Knnw9HIW_pEwaWY6RknWHUjnWYr6Jm)。

因此作为墙内的我们，可以将整个国外的网络环境当成某个公司的内网资源，如果能够在该国外网络中架设一个vpn server，然后我们在墙内连上该vpn server我们就可以访问整个国外的网络资源了。

# 搭建步骤
从原理我们可以知道
1. 需要一个可以访问的国外的vps或者其他能够访问的机器。
2. 搭建vpnserver
3. 搭建vpnclient
4. 通过调整ip转发来优化vpnsever

## 国外vps或者其他可以访问的机器
本文作者使用的是[digitalocean](http://www.digitalocean.com/)，速度不能说很优秀，但是稳定够用。这个vps还有个最大的问题是，其官网需要翻墙访问（--！），所以首次使用的用户谨慎选择。

## 搭建vpnserver
该步骤是整个过程中最复杂的部分，下面我们就一步一步来搭建。vpn server选用的openvpn，开源免费。若本文有说的不清楚的地方，请参考[HOWTO](https://openvpn.net/index.php/open-source/documentation/howto.html#quick)

**下面仅以Ubuntu 15.04为例搭建vpn server，以Mac为例配置vpn client**

1. 安装openvpn server
首先执行命令：
{% highlight sh %}
sudo apt-get install openvpn
{% endhighlight %}

安装完之后关注两个目录
/etc/openvpn: 该目录用于存放真正的配置文件
/usr/share/doc/openvpn/examples: 该目录下提供了示例配置文件

2. 以示例配置openvpn
{% highlight sh %}
# 将examples目录下得keys拷贝到/etc/openvpn/keys目录下
cd /etc/openvpn
mv /usr/share/doc/openvpn/examples /usr/share/doc/openvpn/examples/sample-keys

# 解压缩server.conf.gz
gunzip –c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz > server.conf

# 修改server.conf
                                                                      
local 0.0.0.0

ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key  # This file should be kept secret

dh /etc/openvpn/keys/dh1024.pem

push "redirect-gateway def1 bypass-dhcp"

push "dhcp-option DNS 208.67.222.222"
push "dhcp-option DNS 208.67.220.220"

client-to-client

{% endhighlight %}

3. 启动openvpn
{% highlight sh %}
openvpn /etc/openpvn/server.conf 
# 启动后注意观察terminal的输出，没有error就说明启动成功了
{% endhighlight %}

4. 配置mac客户端
mac客户端使用的是Tunnelblick[https://tunnelblick.net/]
安装完后会弹一个sample的配置文件，和server的几乎一模一样，

首先需要从vpn server下把 /usr/share/doc/openvpn/examples/sample-keys下的ca.crt、client.crt、client.key拷贝到/Users/fragno/Desktop/Tunnelblick VPN 配置样目录下，然后修改配置文件
{% highlight sh %}
# 修改成自己的vpn server地址
remote xxx.xxx.xxx.xxx 1194
{% endhighlight %}

修改文件夹后缀为tblk，然后双击后点击右上角的tunnelblick的连接即可，在vpn server的terminal上可以看到有log，连接成功的话就会有很多成功log，注意观察。

注意：笔者这里使用udp是不能认证成功的，可能网络太差了，把udp换成tcp即可连接成功。连接成功后就算是测试通过了。
**测试成功并不代表可以使用了，如果使用测试的配置进行vpn翻墙，危险是非常大的，下面的工作才是真正创建属于我们自己的vpn的工作**


## 创建能安全使用的vpn